let item_list = [
    { "group_id": 1, "type_id": "1", "label": "風方", "tickets": [], "show": false, "se": false }
    , { "group_id": 2, "type_id": "2", "label": "火方", "tickets": [], "show": false, "se": false }
    , { "group_id": 3, "type_id": "3", "label": "水方", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "4", "label": "土方", "tickets": [], "show": false, "se": false }
    , { "group_id": 5, "type_id": "5", "label": "光方", "tickets": [], "show": false, "se": false }
    , { "group_id": 6, "type_id": "6", "label": "暗方", "tickets": [], "show": false, "se": false }

    , { "group_id": 1, "type_id": "100001", "label": "風方HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 2, "type_id": "100002", "label": "火方HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 3, "type_id": "100003", "label": "水方HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "100004", "label": "土方HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 5, "type_id": "100005", "label": "光方HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 6, "type_id": "100006", "label": "暗方HL", "tickets": [], "show": false, "se": false }

    , { "group_id": 1, "type_id": "120101", "label": "風方2", "tickets": [], "show": false, "se": false }
    , { "group_id": 2, "type_id": "120102", "label": "火方2", "tickets": [], "show": false, "se": false }
    , { "group_id": 3, "type_id": "120103", "label": "水方2", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "120104", "label": "土方2", "tickets": [], "show": false, "se": false }
    , { "group_id": 5, "type_id": "120105", "label": "光方2", "tickets": [], "show": false, "se": false }
    , { "group_id": 6, "type_id": "120106", "label": "暗方2", "tickets": [], "show": false, "se": false }

    , { "group_id": 1, "type_id": "100101", "label": "風召1", "tickets": [], "show": false, "se": false }
    , { "group_id": 2, "type_id": "100102", "label": "火召1", "tickets": [], "show": false, "se": false }
    , { "group_id": 3, "type_id": "100103", "label": "水召1", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "100104", "label": "土召1", "tickets": [], "show": false, "se": false }
    , { "group_id": 5, "type_id": "100105", "label": "光召1", "tickets": [], "show": false, "se": false }
    , { "group_id": 6, "type_id": "100106", "label": "暗召1", "tickets": [], "show": false, "se": false }
 
    , { "group_id": 1, "type_id": "100201", "label": "風召2", "tickets": [], "show": false, "se": false }
    , { "group_id": 2, "type_id": "100202", "label": "火召2", "tickets": [], "show": false, "se": false }
    , { "group_id": 3, "type_id": "100203", "label": "水召2", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "100204", "label": "土召2", "tickets": [], "show": false, "se": false }
    , { "group_id": 5, "type_id": "100205", "label": "光召2", "tickets": [], "show": false, "se": false }
    , { "group_id": 6, "type_id": "100206", "label": "暗召2", "tickets": [], "show": false, "se": false }

    , { "group_id": 3, "type_id": "100503", "label": "水擊滅", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "100504", "label": "土擊滅", "tickets": [], "show": false, "se": false }
     
    , { "group_id": 7, "type_id": "100905", "label": "丁丁", "tickets": [], "show": false, "se": false }
    , { "group_id": 7, "type_id": "100906", "label": "小巴", "tickets": [], "show": false, "se": false }

    , { "group_id": 7, "type_id": "110001", "label": "BBA", "tickets": [], "show": false, "se": false }

    , { "group_id": 1, "type_id": "120001", "label": "風召2HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 2, "type_id": "120002", "label": "火召2HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 3, "type_id": "120003", "label": "水召2HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "120004", "label": "土召2HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 5, "type_id": "120005", "label": "光召2HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 6, "type_id": "120006", "label": "暗召2HL", "tickets": [], "show": false, "se": false }

    , { "group_id": 1, "type_id": "100301", "label": "風天司", "tickets": [], "show": false, "se": false }
    , { "group_id": 2, "type_id": "100302", "label": "火天司", "tickets": [], "show": false, "se": false }
    , { "group_id": 3, "type_id": "100303", "label": "水天司", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "100304", "label": "土天司", "tickets": [], "show": false, "se": false }

    , { "group_id": 7, "type_id": "150005", "label": "路西法", "tickets": [], "show": false, "se": false }
    , { "group_id": 7, "type_id": "150006", "label": "U巴N", "tickets": [], "show": false, "se": false }
    , { "group_id": 7, "type_id": "150106", "label": "大巴", "tickets": [], "show": false, "se": false }

    , { "group_id": 1, "type_id": "120201", "label": "風鞄HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 2, "type_id": "120202", "label": "火鞄HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 3, "type_id": "120203", "label": "水鞄HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "120204", "label": "土鞄HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 5, "type_id": "120205", "label": "光鞄HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 6, "type_id": "120206", "label": "暗鞄HL", "tickets": [], "show": false, "se": false }

    , { "group_id": 1, "type_id": "60001", "label": "東青1", "tickets": [], "show": false, "se": false }
    , { "group_id": 2, "type_id": "60002", "label": "南朱1", "tickets": [], "show": false, "se": false }
    , { "group_id": 3, "type_id": "60003", "label": "北玄1", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "60004", "label": "西白1", "tickets": [], "show": false, "se": false }

    , { "group_id": 1, "type_id": "90001", "label": "東青2", "tickets": [], "show": false, "se": false }
    , { "group_id": 2, "type_id": "90002", "label": "南朱2", "tickets": [], "show": false, "se": false }
    , { "group_id": 3, "type_id": "90003", "label": "北玄2", "tickets": [], "show": false, "se": false }
    , { "group_id": 4, "type_id": "90004", "label": "西白2", "tickets": [], "show": false, "se": false }

    , { "group_id": 7, "type_id": "100405", "label": "黄龍", "tickets": [], "show": false, "se": false }
    , { "group_id": 7, "type_id": "100406", "label": "黒麒麟", "tickets": [], "show": false, "se": false }
    , { "group_id": 7, "type_id": "120307", "label": "黄龍・黒麒麟HL", "tickets": [], "show": false, "se": false }
    , { "group_id": 7, "type_id": "200007", "label": "四大天司HL", "tickets": [], "show": false, "se": false }

    , { "group_id": 7, "type_id": "999", "label": "50未滿", "tickets": [], "show": false, "se": false }
    , { "group_id": 7, "type_id": "995", "label": "其他", "tickets": [], "show": false, "se": false }
];

function getItems(group_id) {
    let result = [];
    item_list.forEach((element) => {
        if (element.group_id === group_id) {
            result.push(element);
        }
    })
    return result;
}

let base = new Vue({
    el: "#vue-prpr",
    data: {
        groups: [
            getItems(1)
            , getItems(2)
            , getItems(3)
            , getItems(4)
            , getItems(5)
            , getItems(6)
            , getItems(7)
            , getItems(8)
            , getItems(9)
            , getItems(10)
            , getItems(11)
            , getItems(12)
        ]
        , list: item_list
        , version: "VER. 2.0.5"
        , connections: 0
        , request_time: "5 SEC"
        , count_request: 0
        , count_streaming: 0
        , last_updated_time: ""
        , connection_status: ""
        , btn_show: true
    }
    , methods: {
        onClickShowAllTicket: () => {
            base.list.forEach((element) => {
                element.show = true;
            })
        }
        , onClickHideAllTicket: () => {
            base.list.forEach((element) => {
                element.show = false;
            })
        }
    }
})

function doParseTime(val) {
    val = new Date(val);
    return (val.getHours() < 10 ? "0" + val.getHours() : val.getHours()) + ":" +
        (val.getMinutes() < 10 ? "0" + val.getMinutes() : val.getMinutes()) + ":" +
        (val.getSeconds() < 10 ? "0" + val.getSeconds() : val.getSeconds());
}

let ws = null;
let tid = 0;

function doParseInfoMessage(message) {
    base.count_request = message.info.total_status.request;
    base.count_streaming = message.info.total_status.streaming;
    base.connections = message.info.connections;

    base.list.forEach((element) => {
        element.counts = message.info.total_status[element.type_id];
    })
}

function doParseItemMessage(message) {
    let target_index = getTicketsIndex(message.item.type);
    if (target_index != null) {
        let level = message.item.level;
        let by = message.item.by;
        let level_color = "label-info";
        let code_color = "white";

        level_color = level >= 50 && level <= 100 ? "label-warning" : level_color;
        level_color = level >= 100 ? "label-danger" : level_color;

        code_color = by == "streaming" ? "red" : code_color;

        message.item.level_color = level_color;
        message.item.code_color = code_color;
        message.item.opacity = 1;

        base.list[target_index].tickets.splice(0, 0, message.item);

        if (base.list[target_index].tickets.length > 6) {
            base.list[target_index].tickets = base.list[target_index].tickets.slice(0, 6);
        }

        if (base.list[target_index].se) {
            if (by == "streaming") {
                doPlaySE_S();
            } else {
                doPlaySE_R();
            }
        }

        base.list[target_index].tickets.sort((a, b) => {
            return a.time_num > b.time_num ? -1 : 1;
        })
    }
}

function doInitWS() {
    if (ws != null) {
        try {
            ws.close();
        } catch (err) {
            console.log(err);
        }

        ws = null;
    }

    ws = new WebSocket("wss://prpr.pickoma.com:8443", "echo-protocol");
    tid = 0;

    ws.onmessage = (e) => {
        let rece = JSON.parse(e.data);

        if (rece.command == "info") {
            doParseInfoMessage(rece);
        }

        if (rece.command == "item") {
            doParseItemMessage(rece);
        }

        base.connection_status = "";
    }

    ws.onclose = (e) => {
        base.connection_status = "Failed.";
        doInitWS();
    }
}
 
function getTicketsIndex(type_id) {
    let res = base.list.findIndex((element) => { return element.type_id == type_id });
    return res != -1 ? res : null;
}

function notifyMe(val) {
    if (!("Notification" in window)) {
        //alert("This browser does not support desktop notification");
    }

    else if (Notification.permission === "granted") {
        let notification = new Notification(val);
    }

    else if (Notification.permission !== "denied") {
        Notification.requestPermission(function (permission) {
            if (permission === "granted") {
                let notification = new Notification(val);
            }
        });
    }
}

function gd(name, url) {
    if (!url) url = location.href;
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    let regexS = "[\\?&]" + name + "=([^&#]*)";
    let regex = new RegExp(regexS);
    let results = regex.exec(url);
    return results == null ? "" : results[1];
}

function doPlaySE_R() {
    document.getElementById("se_r").volume = 0.2;
    document.getElementById("se_r").play();
}

function doPlaySE_S() {
    document.getElementById("se_s").volume = 0.2;
    document.getElementById("se_s").play();
}

new Clipboard('.list-group-item');

doInitWS();