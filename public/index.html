<html>
<head>
    <!-- http://usebootstrap.com/preview/darkly/# -->
    <title>力爭上歐</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="keywords"           content="gbf">
    <meta property="og:title"       content="力爭上歐"/>
    <meta property="og:type"        content="website"/>
    <meta property="og:url"         content="https://prpr.pickoma.com"/>
    <meta property="og:site_name"   content="力爭上歐"/>
    <meta name="viewport"           content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="darkly/theme/bootstrap.css" media="screen">
    <link rel="stylesheet" href="darkly/theme/usebootstrap.css">

    <link href="./styles/c3.css" rel="stylesheet" type="text/css">
     
    <style>
        ul {
            padding-bottom:5px;
        }

        .code-mark {
            margin-left : 10px ;
        }

        .con-body .col-md-3 {
            min-height:450px ;
        }

        .list-group-item span {
            margin-left : 10px;
        }

        .btn {
            margin-bottom: 5px;
        }

        /*.chart {
            height:100px;
        }*/

    </style>

</head>
<body>
<p class="pmsg"></p>
<div class="container-fluid">
    <div class="row con-menu">
        <div class="col-lg-6 con-btn-bar">
            <h1>力爭上歐</h1> 
            <span class="label label-success">Ver. 1.1.4</span>
            <span class="label label-success online"></span>
            <span class="label label-success">5 SEC</span>
            <span class="label label-success">80 TWEET</span>
            <span class="label label-success label-rc">GET: ---</span>
            <span class="label label-success label-sc">STREAMING: ---</span>
            <span class="label label-success ws-update-time"></span>
            <span class="label label-warning ws-bad">Failed</span>
        </div>
        <div id="chart" class="col-lg-6 chart">
        </div>
    </div>
    <hr/>
    <div class="row con-toggle">
        
        <div class="col-lg-2 con-btn-bar">
            <button type="button" class="btn btn-primary btn-tg" t-type="all">全部切換</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="all-show">全部顯示</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="all-hide">全部隱藏</button>
            
        </div>

        <div class="col-lg-2 con-btn-bar">
            <button type="button" class="btn btn-primary btn-tg" t-type="1">風EX</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="2">火EX</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="3">水EX</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="4">土EX</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="5">光EX</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="6">暗EX</button>
        </div>
        
        <div class="col-lg-2 con-btn-bar">
            <button type="button" class="btn btn-primary btn-tg" t-type="10001">風HL</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="10002">火HL</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="10003">水HL</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="10004">土HL</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="10005">光HL</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="10006">暗HL</button>
        </div>
        
        <div class="col-lg-2 con-btn-bar">
            <button type="button" class="btn btn-primary btn-tg" t-type="10010">召喚石1</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="10020">召喚石2</button>
        </div>

        <div class="col-lg-2 con-btn-bar">
            <button type="button" class="btn btn-primary btn-tg" t-type="12020">召喚石HL</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="10000">其他1</button>
            <button type="button" class="btn btn-primary btn-tg" t-type="999">其他2</button>
        </div>
        
    </div>
    <hr/>
    <div class="row con-body">
        <div class="col-md-4 list-type list-10000">
            <ul class="nav nav-pills">
               <li><a>其他1<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-10000">
            </ul>
        </div>

        <div class="col-md-4 list-type list-999">
            <ul class="nav nav-pills">
               <li><a>其他2<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-999">
            </ul>
        </div>

        <div class="col-md-4 list-type list-1">
            <ul class="nav nav-pills">
               <li><a>風EX<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-1">
            </ul>
        </div>

        <div class="col-md-4 list-type list-2">
           <ul class="nav nav-pills">
               <li><a>火EX<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-2">
            </ul>
        </div> 

        <div class="col-md-4 list-type list-3">
            <ul class="nav nav-pills">
               <li><a>水EX<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-3">
            </ul>
        </div>

        <div class="col-md-4 list-type list-4">
            <ul class="nav nav-pills">
               <li><a>土EX<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-4">
            </ul>
        </div>

        <div class="col-md-4 list-type list-5">
            <ul class="nav nav-pills">
               <li><a>光EX<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-5">
            </ul>
        </div>

        <div class="col-md-4 list-type list-6">
            <ul class="nav nav-pills">
               <li><a>暗EX<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-6">
            </ul>
        </div> 

        <div class="col-md-4 list-type list-10001">
            <ul class="nav nav-pills">
               <li><a>風HL<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-10001">
            </ul>
        </div>

        <div class="col-md-4 list-type list-10002">
            <ul class="nav nav-pills">
               <li><a>火HL<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-10002">
            </ul>
        </div>
        
        <div class="col-md-4 list-type list-10003">
            <ul class="nav nav-pills">
               <li><a>水HL<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-10003">
            </ul>
        </div>
        
        <div class="col-md-4 list-type list-10004">
            <ul class="nav nav-pills">
               <li><a>土HL<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-10004">
            </ul>
        </div>
        
        <div class="col-md-4 list-type list-10005">
            <ul class="nav nav-pills">
               <li><a>光HL<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-10005">
            </ul>
        </div>

        <div class="col-md-4 list-type list-10006">
            <ul class="nav nav-pills">
               <li><a>暗HL<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-10006">
            </ul>
        </div>
        
        <div class="col-md-4 list-type list-10010">
            <ul class="nav nav-pills">
               <li><a>召喚石1<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-10010">
            </ul>
        </div>

        <div class="col-md-4 list-type list-10020">
            <ul class="nav nav-pills">
               <li><a>召喚石2<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-10020">
            </ul>
        </div>

        <div class="col-md-4 list-type list-12020">
            <ul class="nav nav-pills">
               <li><a>召喚石HL<span class="badge">0</span></a></li>
            </ul>
            <ul class="list-group codelist-12020">
            </ul>
        </div>
    </div>
</div>

<a href="https://github.com/Kcars/gbf-prpr"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="darkly/bootstrap/bootstrap.min.js"></script>
<script src="darkly/bootstrap/usebootstrap.js"></script>


<script src="./js/d3.js" charset="utf-8"></script>
<script src="./js/c3.js"></script>

<script>

var codeHistory = [] ;

function compare(a,b) {
  if (a.ftime < b.ftime)
    return -1;
  if (a.ftime > b.ftime)
    return 1;
  return 0;
}

function doParsePrpr(list) {

    var typeList = [] ;

    list.sort(compare) ;

    list.forEach(function (element) {
        var tt = element.kind ;
        var lv = element.lv ;
        var cc = element.code ;
        var na = element.name ;
        var ti = element.ftime ;
        var ff = element.by ;

        if ( !Array.isArray( codeHistory[tt] ) ) { codeHistory[tt] = [] } ;
        if ( codeHistory[tt].length >= 1000 )    { codeHistory[tt] = [] } ;

        appendCode(tt , cc , na , lv , ti , ff , codeHistory[tt]) ;

        codeHistory[tt].push(cc) ;
        typeList.push(tt) ;
    } ) ;

    typeList.forEach( function ( val ) { 
        $(".codelist-" + val).children(".list-group-item").children(".code").each(function(index , element) {
        if ( index > 4 ) {
            $(element).parent().fadeOut(500 , function() {
                this.remove() ;
            }) ;
        }
    })
    } )

    
}

function doParseMark(list) {
    list.forEach(function (element) {
        var info = element.split(":") ;
        var tt   = info[0] ;
        var cc   = info[1] ;

        markCode(tt , cc) ;
    } ) ;
} 

function doTrackTooOldCode() {
    var targets = $(".list-group-item").find(".badge") ; // span
 
    targets.each(function(index , element) { 
        var tt  = $(element).text().split(":")[0] + $(element).text().split(":")[1] ;
        var itt = parseInt(tt) ;
        
        var ct  = new Date().getHours().toString() + new Date().getMinutes().toString() ;
        var ict = parseInt(ct) ;

        var isOld = ict - itt >= 5 ;

        
        if( isOld ) { $( $(element).parent().get(0) ).fadeOut(500 , function() {
            console.log("too-old-remove") ;
            console.log("tt:" + tt + " , ct:" + ct ) ;
            this.remove() ;
        })}
    })
}

function doParseTime ( val ) {
    val = new Date(val) ;
    return (val.getHours()   < 10 ? "0" + val.getHours()   : val.getHours()   ) + ":" +
           (val.getMinutes() < 10 ? "0" + val.getMinutes() : val.getMinutes() ) + ":" +
           (val.getSeconds() < 10 ? "0" + val.getSeconds() : val.getSeconds() ) ;
}

var ws  = new WebSocket("wss://prpr.pickoma.com:8443" , "echo-protocol") ;
var tid = 0 ; 

ws.onmessage = function(e) {
      var rece = JSON.parse(e.data) ;
      doTrackTooOldCode() ;

      if( rece.prpr != null && rece.prpr.length > 0 ) { doParsePrpr(rece.prpr) ; }
      if( rece.mark != null && rece.mark.length > 0 ) { doParseMark(rece.mark) ; }

      $(".ws-update-time").text( "UPDATE TIME: " + doParseTime(rece.info.lut) ) ;
      $(".online").text(rece.info.connections + " ONLINE") ;
      $(".ws-bad").text("") ;

      $(".label-rc").text("REQUEST: " + rece.info.rc) ;
      $(".label-sc").text("STREAMING: " + rece.info.sc) ;
}

ws.onclose = function (e) {
    $(".ws-bad").text("Failed") ;
    
    /*setTimeout(function(target) {
        console.log("reconnect...") ;
        target = new WebSocket("ws://prpr.pickoma.com:8080" , "echo-protocol") ;
    } , 5000 , ws) ;*/
}

function appendCode (tt , cc , na , lv , ti , ff , alist) {
    var lm = lv == "Lv100" || lv == "Lv110" || lv == "Lv120" || lv == "Lv150" ? "label-danger" : "label-info" ;

    var re = ff == "streaming" ? "red" : "white" ;

    var html = "<li class=\"list-group-item\"><span class=\"code\">" + cc + "</span><span>"+na+"</span><span class=\"label " + lm + "\">" + lv + "</span><span class=\"badge\" style=\"color:"+re+"\">" + ti + "</span></li>" ;
 
    var alreadyIn = alist.indexOf( cc ) == -1 ? false : true ;

    if ( !alreadyIn ) {
        $(html).prependTo(".codelist-" + tt).hide().fadeIn(500) ;
    } else {
    }
}

function markCode (tt , cc) {
     var items = $(".codelist-" + tt + " span:contains(" + cc + ")") ;
     
     items.each(function(index , element){
        if (!$(element).parent().is("del") ) {
            $($(element).parent().get(0)).addClass("code-marked") ;
            $(element).wrap("<del>") ;
        }
     })
}

////////
////////
////////

$(".btn-tg").on("click" , function(){
    var type = $(this).attr("t-type") ; // null?type:1 ???

    switch ( type ) {
        case "all" :
            $(".list-type").fadeToggle();
        break ;

        case "all-show" :
            $(".list-type").hide().fadeIn(500) ;
        break ;

        case "all-hide" :
            $(".list-type").fadeOut(500) ;// , function() { this.remove() ; }) ;
        break ;

        default : 
            $(".list-" + type).fadeToggle();
        break ;
    }
    
})
    
</script>
</body>
</html>